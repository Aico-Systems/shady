services:
  postgres:
    image: pgvector/pgvector:pg17
    container_name: booking_postgres
    ports:
      - "5436:5432"
    environment:
      POSTGRES_DB: booking_service
      POSTGRES_USER: booking_user
      POSTGRES_PASSWORD: booking_password
    volumes:
      - booking_postgres_data:/var/lib/postgresql/data
      - ./backend/src/db/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U booking_user -d booking_service"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - booking_network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: booking_backend
    ports:
      - "5006:5006"
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://booking_user:booking_password@postgres:5432/booking_service
      - PORT=5006
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./backend/src:/app/src:ro
      - ./google.json:/app/google.json:ro
    networks:
      - booking_network
    restart: unless-stopped

  admin:
    build:
      context: ./admin
      dockerfile: Dockerfile
    container_name: booking_admin
    ports:
      - "5175:5175"
    environment:
      - VITE_BACKEND_URL=http://localhost:5006
    volumes:
      - ./admin/src:/app/src
      - /app/node_modules
      - ./.env:/workspace/.env.development:ro
    networks:
      - booking_network
    restart: unless-stopped

  widget-dev:
    build:
      context: ./widget
      dockerfile: Dockerfile
    container_name: booking_widget
    ports:
      - "5174:5174"
    environment:
      - VITE_BACKEND_URL=http://localhost:5006
    volumes:
      - ./widget/src:/app/src
      - /app/node_modules
      - ./.env:/workspace/.env.development:ro
    networks:
      - booking_network
    restart: unless-stopped

  drizzle-studio:
    image: node:20-alpine
    container_name: booking_drizzle_studio
    working_dir: /workspace
    entrypoint: ["/bin/sh", "/entrypoint.sh"]
    environment:
      NODE_ENV: development
      STUDIO_PORT: 4985
    volumes:
      - drizzle_studio_workspace:/workspace
      - ./backend:/app/backend:ro
      - ./.env:/workspace/.env:ro
      - ./scripts/drizzle-studio-entrypoint.sh:/entrypoint.sh:ro
    ports:
      - "4985:4985"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - booking_network
    restart: "no"

volumes:
  booking_postgres_data:
  drizzle_studio_workspace:

networks:
  booking_network:
    driver: bridge
